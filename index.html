<!DOCTYPE html>
<html lang="ja" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI時代のパスワード強度チェッカー & 解析ツール Pro (2025 Edition)</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <!-- Highcharts -->
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <script src="https://code.highcharts.com/themes/grid-light.js"></script>

    <style>
        :root {
            --color-step1: #ff0000;
            --color-step2: #ff4500;
            --color-step3: #ff8c00;
            --color-step4: #ffd700;
            --color-step5: #adff2f;
            --color-step6: #32cd32;
            --color-step7: #008000;
            --color-step8: #1e90ff;
            --color-step9: #4169e1;
            --color-step10: #7f00ff;
        }

        body {
            font-family: 'Roboto', 'Noto Sans JP', sans-serif;
            background-color: #f8f9fa;
            transition: background-color 0.3s, color 0.3s;
            padding-bottom: 80px;
        }

        [data-bs-theme="dark"] body {
            background-color: #212529;
            color: #f8f9fa;
        }

        .main-container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .card {
            border: 1px solid rgba(0,0,0,0.125);
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            transition: transform 0.2s, background-color 0.3s, border-color 0.3s;
            border-radius: 12px;
            overflow: hidden;
        }
        [data-bs-theme="dark"] .card {
            border-color: rgba(255,255,255,0.15);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .result-card {
            padding: 25px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .result-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 15px 0;
            word-break: break-word;
            line-height: 1.2;
        }
        
        .result-label {
            font-size: 0.95rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        [data-bs-theme="dark"] .result-label { color: #adb5bd; }

        .strength-bar-container {
            height: 12px;
            background-color: #e9ecef;
            border-radius: 6px;
            overflow: hidden;
            margin-top: 15px;
        }
        [data-bs-theme="dark"] .strength-bar-container {
            background-color: #343a40;
        }

        .strength-bar-indicator {
            height: 100%;
            width: 0%;
            transition: width 0.5s cubic-bezier(0.22, 1, 0.36, 1), background-color 0.5s ease;
        }

        .crit-badge {
            font-size: 0.85rem;
            padding: 8px 12px;
            border-radius: 20px;
            margin-right: 5px;
            margin-bottom: 5px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background-color: #e9ecef;
            color: #6c757d;
            border: 1px solid transparent;
            transition: all 0.3s;
        }
        [data-bs-theme="dark"] .crit-badge {
            background-color: #343a40;
            color: #adb5bd;
        }
        .crit-badge.met {
            background-color: #d1e7dd;
            color: #0f5132;
            border-color: #badbcc;
        }
        [data-bs-theme="dark"] .crit-badge.met {
            background-color: #051b11;
            color: #75b798;
            border-color: #0f5132;
        }

        /* Device Grid System */
        .device-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        @media (min-width: 768px) {
            .device-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (min-width: 1200px) {
            .device-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .device-card {
            background-color: #f8f9fa;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        [data-bs-theme="dark"] .device-card {
            background-color: rgba(255,255,255,0.05);
            border-color: rgba(255,255,255,0.1);
        }
        .device-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding-bottom: 8px;
        }
        [data-bs-theme="dark"] .device-header {
            border-bottom-color: rgba(255,255,255,0.1);
        }

        .device-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: #495057;
        }
        [data-bs-theme="dark"] .device-name {
            color: #e9ecef;
        }
        .device-time {
            font-weight: 700;
            font-size: 1.0rem;
            color: #0d6efd;
        }
        [data-bs-theme="dark"] .device-time {
            color: #6ea8fe;
        }
        .device-desc {
            font-size: 0.8rem;
            color: #6c757d;
            line-height: 1.4;
        }
        [data-bs-theme="dark"] .device-desc {
            color: #adb5bd;
        }

        .popover { max-width: 400px; }

        /* Table Styling */
        .table-responsive {
            max-height: 600px;
            overflow-y: auto;
        }
        th {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 10;
        }
        [data-bs-theme="dark"] th {
            background-color: #212529;
            color: #fff;
        }

        /* Chart Reset Button */
        .chart-reset-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
        }

        /* Logic View Styling */
        .logic-code-block {
            background-color: #f1f3f5;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.85rem;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            margin-bottom: 10px;
            white-space: pre-wrap;
        }
        [data-bs-theme="dark"] .logic-code-block {
            background-color: #2b3035;
            border-color: #495057;
            color: #e9ecef;
        }
        .logic-list-item {
            margin-bottom: 8px;
            padding-left: 10px;
            border-left: 3px solid #6c757d;
        }

        /* Color Utility Classes */
        .color-step1 { background-color: var(--color-step1) !important; color: white !important; }
        .color-step2 { background-color: var(--color-step2) !important; color: white !important; }
        .color-step3 { background-color: var(--color-step3) !important; color: #212529 !important; }
        .color-step4 { background-color: var(--color-step4) !important; color: #212529 !important; }
        .color-step5 { background-color: var(--color-step5) !important; color: #212529 !important; }
        .color-step6 { background-color: var(--color-step6) !important; color: #212529 !important; }
        .color-step7 { background-color: var(--color-step7) !important; color: white !important; }
        .color-step8 { background-color: var(--color-step8) !important; color: white !important; }
        .color-step9 { background-color: var(--color-step9) !important; color: white !important; }
        .color-step10 { background-color: var(--color-step10) !important; color: white !important; }

        .text-step1 { color: var(--color-step1); }
        .text-step2 { color: var(--color-step2); }
        .text-step3 { color: var(--color-step3); }
        .text-step4 { color: var(--color-step4); }
        .text-step5 { color: var(--color-step5); }
        .text-step6 { color: var(--color-step6); }
        .text-step7 { color: var(--color-step7); }
        .text-step8 { color: var(--color-step8); }
        .text-step9 { color: var(--color-step9); }
        .text-step10 { color: var(--color-step10); }

        #passwordInput {
            font-size: 1.3rem;
            padding: 18px;
            letter-spacing: 1px;
            border-radius: 8px;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg sticky-top bg-body-tertiary shadow-sm">
        <div class="container-fluid px-4">
            <a class="navbar-brand d-flex align-items-center gap-2" href="#">
                <i class="bi bi-shield-lock-fill text-primary fs-3"></i>
                <span class="fw-bold fs-4">PasswordCheck Pro</span>
            </a>
            <button class="btn btn-outline-secondary" id="themeToggle" title="テーマ切り替え">
                <i class="bi bi-circle-half"></i>
            </button>
        </div>
    </nav>

    <div class="main-container">
        
        <!-- Input Section -->
        <div class="row justify-content-center mb-5">
            <div class="col-lg-8">
                <div class="text-center mb-4">
                    <h1 class="fw-light mb-2">AI時代のパスワード強度チェッカー</h1>
                    <p class="fs-4 text-danger fw-bold mb-3">そのパスワード、1秒で破られませんか？</p>
                    <p class="text-muted">あなたのパスワードは、AIの進化に耐えられますか？<br>Powered by Advanced Entropy & Hashrate Analysis (2025 Edition)</p>
                </div>
                
                <div class="card p-4">
                    <div class="input-group mb-3">
                        <span class="input-group-text bg-body"><i class="bi bi-key fs-4"></i></span>
                        <input type="password" id="passwordInput" class="form-control" placeholder="ここにパスワードを入力してください..." aria-label="Password">
                        <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                            <i class="bi bi-eye-fill"></i>
                        </button>
                    </div>
                    
                    <div class="strength-bar-container mb-4">
                        <div class="strength-bar-indicator" id="strengthBarIndicator"></div>
                    </div>

                    <div class="d-flex flex-wrap justify-content-center gap-2 mb-3" id="criteriaList">
                        <span class="crit-badge" id="lengthCheck"><i class="bi bi-x-circle"></i> 8文字以上</span>
                        <span class="crit-badge" id="uppercaseCheck"><i class="bi bi-x-circle"></i> 大文字</span>
                        <span class="crit-badge" id="lowercaseCheck"><i class="bi bi-x-circle"></i> 小文字</span>
                        <span class="crit-badge" id="numberCheck"><i class="bi bi-x-circle"></i> 数字</span>
                        <span class="crit-badge" id="symbolCheck"><i class="bi bi-x-circle"></i> 記号</span>
                    </div>

                    <div class="alert alert-light border d-flex align-items-center py-2 justify-content-center" role="alert">
                        <i class="bi bi-shield-check text-success me-2 fs-5"></i>
                        <div class="small text-muted">
                            パスワードはブラウザ内で安全に処理され、外部に送信されることはありません。
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Crack Time & Device List (Large Width) -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body p-4">
                        <div class="row align-items-center mb-4 border-bottom pb-4">
                            <div class="col-lg-6 text-center text-lg-start">
                                <div class="result-label justify-content-center justify-content-lg-start mb-2">
                                    解析時間 (目安)
                                    <!-- Button 1: 解析時間について -->
                                    <button type="button" class="btn btn-link p-0 text-muted" data-bs-toggle="popover" data-bs-title="解析時間 (目安) とは" data-bs-content="このカードの時間は、辞書攻撃やキーボードパターン（qwerty等）、AIによる推測パターンを検知して計算されています。<br><strong>※『パターンを考慮』しています。</strong>ランダムでないパスワードは、下の表よりも大幅に早い時間がここに表示されます。">
                                        <i class="bi bi-info-circle-fill"></i>
                                    </button>
                                </div>
                                <div class="result-value display-4 my-2" id="crackTime">-</div>
                                <div class="d-flex align-items-center justify-content-center justify-content-lg-start gap-2">
                                    <div class="badge bg-primary-subtle text-primary border border-primary-subtle">
                                        基準: 解析リグ (RTX 5090 x8) @ 280 GH/s
                                    </div>
                                    <!-- Button 2: 基準デバイスについて -->
                                    <button type="button" class="btn btn-link p-0 text-muted" data-bs-toggle="popover" data-bs-title="基準デバイスの性能" data-bs-content="表示されているメインの時間は、<strong>解析リグ (RTX 5090 x8)</strong> を使用し、毎秒 <strong>約2,800億回 (280 GH/s)</strong> の試行を行った場合の推定時間です。<br>これは最新のマイニング専用機1台（約360 TH/s）の1000分の1以下の性能です。">
                                        <i class="bi bi-info-circle-fill"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-lg-6 mt-3 mt-lg-0">
                                <div class="alert alert-secondary mb-0 small">
                                    <i class="bi bi-info-circle me-2"></i>
                                    この時間は、攻撃者がパターン検知（辞書・AI推測）を併用した総当たり攻撃を行った場合の理論値です。
                                    <strong>パターンが検出されると、解析時間は劇的に短縮されます。</strong>
                                </div>
                            </div>
                        </div>

                        <h5 class="fw-light mb-3"><i class="bi bi-speedometer me-2"></i>各デバイスでの推定解析時間</h5>
                        <div id="deviceTimeList" class="device-grid">
                            <!-- Generated by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secondary Metrics Row -->
        <div class="row g-4 mb-5">
            <!-- Strength Level -->
            <div class="col-md-6">
                <div class="card result-card h-100">
                    <div>
                        <div class="result-label">
                            強度レベル
                            <button type="button" class="btn btn-link p-0 text-muted" data-bs-toggle="popover" data-bs-title="パスワード強度" data-bs-content="解析時間を基にした総合的な安全性評価です。文字の種類、長さ、予測可能性（辞書やキーボードパターン）から算出されます。">
                                <i class="bi bi-info-circle-fill"></i>
                            </button>
                        </div>
                        <div class="result-value" id="passwordStrength">-</div>
                        <div class="progress mt-3" style="height: 10px;">
                            <div class="progress-bar" id="strengthProgress" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <div class="result-label mb-2"><i class="bi bi-exclamation-triangle me-1"></i>検出されたパターン</div>
                        <div id="patternList">
                            <span class="text-muted fst-italic small">パターンは検出されていません</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Entropy & Composition -->
            <div class="col-md-6">
                <div class="card result-card h-100">
                    <div class="result-label">
                        エントロピー / 構成比
                        <button type="button" class="btn btn-link p-0 text-muted" data-bs-toggle="popover" data-bs-title="エントロピーとは？" data-bs-content="パスワードの「情報量」や「予測困難性」をビット(bit)単位で表したものです。数値が高いほどランダム性が高く、推測が困難であることを示します。<br>目安: 60bit以上で実用的、100bit以上で非常に強力。">
                            <i class="bi bi-info-circle-fill"></i>
                        </button>
                    </div>
                    <div class="row align-items-center h-100">
                        <div class="col-sm-5">
                            <div class="result-value mb-0" id="entropyValue">-</div>
                            <div class="small text-muted">Effective Bits</div>
                        </div>
                        <div class="col-sm-7">
                            <div style="height: 200px; position: relative;">
                                <div id="compositionChart" style="height: 100%; width: 100%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="row mb-5">
            <div class="col-12">
                <h3 class="mb-4 border-bottom pb-2 fw-light"><i class="bi bi-graph-up me-2"></i>詳細分析チャート</h3>
            </div>
            
            <!-- Transition Chart -->
            <div class="col-lg-12 mb-4">
                <div class="card">
                    <div class="card-body" style="position: relative;">
                        <button class="btn btn-sm btn-outline-secondary chart-reset-btn" id="resetTransitionChart">
                            <i class="bi bi-arrow-counterclockwise"></i> リセット
                        </button>
                        <div id="transitionChart" style="height: 350px;"></div>
                    </div>
                </div>
            </div>

            <!-- Device Crack Time Comparison Chart -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <div id="deviceTimeChart" style="height: 400px;"></div>
                    </div>
                </div>
            </div>

            <!-- Hashrate Comparison Chart -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <div id="hashrateChart" style="height: 400px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Tables Section -->
        <div class="row">
            <div class="col-12">
                <h3 class="mb-4 border-bottom pb-2 fw-light"><i class="bi bi-table me-2"></i>データ・基準表</h3>
                
                <div class="accordion" id="dataTablesAccordion">
                    <!-- Crack Time Table -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCrackTime">
                                <i class="bi bi-clock-history me-2"></i>パスワード解析時間の目安表 (理論値: 10^9 試行/秒) - 全323パターン
                            </button>
                        </h2>
                        <div id="collapseCrackTime" class="accordion-collapse collapse show" data-bs-parent="#dataTablesAccordion">
                            <div class="accordion-body">
                                <div class="alert alert-warning small">
                                    <strong><i class="bi bi-exclamation-triangle-fill me-1"></i> 【重要】この表はパターンを考慮していません</strong><br>
                                    この表は、パスワードが<strong>「完全にランダムな文字列」</strong>（例: <code>H9x#kL2$</code>）である場合の理論値です。<br>
                                    「英単語」「名前」「誕生日」「キーボード配列」などを含むパスワードの解析時間は、この表よりも劇的に短くなります。<br>
                                    <strong>パターンを考慮した実際の解析時間を確認したい場合は、ページ上部の『解析時間 (目安)』カードをご覧ください。</strong>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered text-center" id="passwordStrengthTable">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="min-width: 60px;">文字数</th>
                                                <th>数字のみ (10種)</th>
                                                <th>小文字のみ (26種)</th>
                                                <th>大文字小文字 (52種)</th>
                                                <th>数字大文字小文字 (62種)</th>
                                                <th>数字大文字小文字記号 (95種)</th>
                                            </tr>
                                        </thead>
                                        <tbody><!-- JS Generated --></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Strength Levels Table -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseStrength">
                                <i class="bi bi-speedometer2 me-2"></i>強度レベルとエントロピーの基準
                            </button>
                        </h2>
                        <div id="collapseStrength" class="accordion-collapse collapse" data-bs-parent="#dataTablesAccordion">
                            <div class="accordion-body">
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered" id="strengthLevelsTable">
                                        <thead class="table-light">
                                            <tr>
                                                <th>強度レベル (エントロピー目安)</th>
                                                <th>カラーコード</th>
                                            </tr>
                                        </thead>
                                        <tbody><!-- JS Generated --></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Numeric Units Table -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseUnits">
                                <i class="bi bi-123 me-2"></i>英語の数値単位一覧表 (省略なし)
                            </button>
                        </h2>
                        <div id="collapseUnits" class="accordion-collapse collapse" data-bs-parent="#dataTablesAccordion">
                            <div class="accordion-body">
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped" id="numericUnitsTable">
                                        <thead class="table-light">
                                            <tr>
                                                <th>単位 (English Name)</th>
                                                <th>値 (10の何乗)</th>
                                            </tr>
                                        </thead>
                                        <tbody><!-- JS Generated --></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- New: Internal Logic Disclosure -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseLogic">
                                <i class="bi bi-code-square me-2"></i>【完全開示】評価アルゴリズム・内部辞書データ
                            </button>
                        </h2>
                        <div id="collapseLogic" class="accordion-collapse collapse" data-bs-parent="#dataTablesAccordion">
                            <div class="accordion-body">
                                <p class="text-muted small">本ツールが使用している内部のペナルティ計算ロジックと、チェックに使用される辞書データの一覧です。隠し事はありません。</p>
                                <div id="logicDetailsContent">
                                    <!-- Populated by JS -->
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 1. Variables & Constants Declaration ---
            
            // UI Elements
            const passwordInput = document.getElementById('passwordInput');
            const togglePassword = document.getElementById('togglePassword');
            const crackTimeElement = document.getElementById('crackTime');
            const passwordStrengthElement = document.getElementById('passwordStrength');
            const entropyValueElement = document.getElementById('entropyValue');
            const strengthBarIndicator = document.getElementById('strengthBarIndicator');
            const strengthProgress = document.getElementById('strengthProgress');
            const deviceTimeListElement = document.getElementById('deviceTimeList');
            const resetTransitionChartBtn = document.getElementById('resetTransitionChart');
            
            const lengthCheck = document.getElementById('lengthCheck');
            const uppercaseCheck = document.getElementById('uppercaseCheck');
            const lowercaseCheck = document.getElementById('lowercaseCheck');
            const numberCheck = document.getElementById('numberCheck');
            const symbolCheck = document.getElementById('symbolCheck');

            // Theme Toggle
            const themeToggle = document.getElementById('themeToggle');
            const htmlElement = document.documentElement;
            const themeIcon = themeToggle.querySelector('i');

            // Chart Variables
            let compositionChart;
            let deviceTimeChart;
            let hashrateChart;
            let transitionChart;
            let entropyHistory = [];

            // Device Constants with Descriptions
            // Ordered by speed (ascending) for better chart visualization
            const DEVICES = [
                { 
                    name: 'PC CPU (Core Ultra 9 285K)', 
                    speed: 300_000_000n, // ~300 MH/s
                    color: '#17a2b8',
                    desc: 'CPUは汎用処理に特化しているため、ハッシュ計算のような単純作業は苦手です。'
                },
                { 
                    name: 'Android (Snapdragon 8 Elite)', 
                    speed: 1_000_000_000n, // ~1 GH/s
                    color: '#a4c639',
                    desc: '最新のモバイルSoC。CPU/GPUをフル活用してもASICには遠く及びません。'
                },
                { 
                    name: 'iPhone 17 Pro (A19 Pro)', 
                    speed: 1_200_000_000n, // ~1.2 GH/s
                    color: '#6c757d',
                    desc: 'A19 Proの並列演算能力による推計。効率は高いが絶対的なパワーは限定的。'
                },
                { 
                    name: 'Mac (M4 Max)', 
                    speed: 4_000_000_000n, // ~4 GH/s
                    color: '#20c997',
                    desc: '統合された強力なGPUとメモリ帯域により、民生用PCとしては高い数値を出し得ます。'
                },
                { 
                    name: 'GPU (RTX 5090)', 
                    speed: 35_000_000_000n, // ~35 GH/s (Based on SHA-256 estimates)
                    color: '#28a745',
                    desc: '単体GPUでは最強クラス。RTX 4090の約1.5倍〜2倍の性能が見込まれます。'
                },
                { 
                    name: '解析リグ (RTX 5090 x8)', 
                    speed: 280_000_000_000n, // ~280 GH/s
                    color: '#ffc107',
                    desc: 'RTX 5090を8枚並列させた構成。最新のマイニング専用機1台（約360 TH/s）の1000分の1以下です。'
                },
                { 
                    name: 'ボットネット (10k Nodes)', 
                    speed: 50_000_000_000_000n, // ~50 TH/s
                    color: '#fd7e14',
                    desc: '一般的なPC 1万台を乗っ取った場合。個々のパワーは弱くても、数で専用機数台分に匹敵します。'
                },
                { 
                    name: 'スパコン (El Capitan)', 
                    speed: 5_000_000_000_000_000n, // ~5 PH/s
                    color: '#dc3545',
                    desc: '2025年時点の世界最速スパコン。4.4万基超のAPUを連結。総ハッシュ性能は数PH/sに達しますが、暗号通貨網の1/100000以下です。'
                }
            ];

            const ATTEMPTS_PER_SECOND_MAIN = DEVICES[5].speed; // 280 GH/s (Rig)
            const SECONDS_PER_YEAR = 365n * 24n * 60n * 60n;
            const UNCENTILLION_POWER = 306;
            const MAX_DISPLAYABLE_UNCENTILLION_YEARS = 999n * (10n ** BigInt(UNCENTILLION_POWER));
            const MAX_DISPLAYABLE_UNCENTILLION_SECONDS = MAX_DISPLAYABLE_UNCENTILLION_YEARS * SECONDS_PER_YEAR;

            // Updated List based on 2024-2025 Global & Japan Leak Data
            // Sources: NordPass Top 200 (2024), RockYou2024, Soliton Japan Ranking
            const COMMON_PASSWORDS = [
                // Top Global & Numeric Sequences
                '123456', '123456789', '12345', '12345678', '111111', '1234567890', '1234567', 'password', '123123', '987654321',
                '1234', '1111', '000000', '0000', '123123123', '123321', '654321', '12345678910', '112233', '121212',
                '010101', '696969', '777777', '102030', '11111111', '123456789012', '12345678901', '135792468',
                
                // Top Words Global
                'password', 'admin', 'pass', 'root', 'guest', 'user', 'login', 'welcome', 'master', 'secret',
                'iloveyou', 'test', 'unknown', 'system', 'access', 'default', 'security', 'internet', 'computer',
                'public', 'private', 'website', 'online', 'company', 'server', 'support', 'manager', 'service',
                
                // Japan Specific Top Leaked (Romaji Names, Anime, Culture)
                'sakura', 'doraemon', 'baseball', 'hanshin', 'giants', 'dragon', 'takahiro', 'hiroshi', 'kazuya', 'masaki',
                'tomoko', 'hiroko', 'kazuko', 'shinobu', 'yoshiko', 'mayumi', 'kazumi', 'naomi', 'yumi', 'akira',
                'kenji', 'satomi', 'yoshio', 'takashi', 'keiko', 'junko', 'ryohei', 'yosuke', 'daisuke', 'naoki',
                'takeshi', 'manabu', 'makoto', 'satoshi', 'toshi', 'katsumi', 'hideo', 'minoru', 'shigeru', 'kiyoshi',
                'ichiro', 'jiro', 'saburo', 'shiro', 'goro', 'rokuro', 'hachiro', 'kurama', 'sasuke', 'naruto',
                'luffy', 'zoro', 'sanji', 'nami', 'chopper', 'goku', 'vegeta', 'piccolo', 'gohan', 'trunks',
                'pokemon', 'pikachu', 'eevee', 'charizard', 'mario', 'luigi', 'peach', 'bowser', 'zelda', 'link',
                'sony', 'nintendo', 'sega', 'capcom', 'toyota', 'honda', 'nissan', 'suzuki', 'yamaha', 'kawasaki',
                'tokyo', 'osaka', 'nagoya', 'sapporo', 'fukuoka', 'kyoto', 'kobe', 'yokohama', 'saitama', 'chiba',
                'japan', 'nippon', 'nihon', 'samurai', 'ninja', 'geisha', 'sushi', 'tempura', 'ramen', 'anime',
                'manga', 'otaku', 'kawaii', 'sensei', 'senpai', 'kouhai', 'arigato', 'sayonara', 'konnichiwa',
                'nyanmage', 'kumamon', 'funassyi', 'ghibli', 'totoro', 'laputa', 'nausicaa', 'ponyo', 'chihiro',
                
                // English Common Names
                'michael', 'david', 'james', 'john', 'robert', 'william', 'richard', 'thomas', 'daniel', 'matthew',
                'anthony', 'donald', 'mark', 'paul', 'steven', 'andrew', 'kenneth', 'joshua', 'kevin', 'brian',
                'george', 'edward', 'ronald', 'timothy', 'jason', 'jeffrey', 'ryan', 'jacob', 'gary', 'nicholas',
                'jennifer', 'linda', 'susan', 'jessica', 'sarah', 'karen', 'nancy', 'lisa', 'betty', 'margaret',
                'sandra', 'ashley', 'kimberly', 'emily', 'donna', 'michelle', 'dorothy', 'carol', 'amanda', 'melissa',
                'deborah', 'stephanie', 'rebecca', 'sharon', 'laura', 'cynthia', 'kathleen', 'amy', 'shirley', 'angela',
                'charlie', 'alex', 'max', 'sam', 'ben', 'dan', 'tom', 'harry', 'jack', 'joe',
                
                // Phrases & Slang (2024-2025)
                'skibidi', 'sigma', 'rizz', 'gyatt', 'fanum', 'tax', 'ohio', 'bruh', 'cringe', 'based',
                'whatever', 'forever', 'together', 'starwars', 'superman', 'batman', 'spiderman', 'ironman',
                'avengers', 'marvel', 'disney', 'netflix', 'spotify', 'youtube', 'google', 'facebook', 'twitter',
                'amazon', 'apple', 'microsoft', 'windows', 'linux', 'android', 'iphone', 'samsung', 'huawei',
                'minecraft', 'roblox', 'fortnite', 'valorant', 'apex', 'league', 'dota', 'overwatch', 'callofduty',
                'gta', 'rdr2', 'skyrim', 'fallout', 'cyberpunk', 'eldenring', 'darksouls', 'bloodborne', 'sekiro',
                
                // Keyboard Patterns (QWERTY / QWERTZ / AZERTY / JIS)
                'qwerty', 'qwer', 'qwert', 'qwertyuiop', 'asdf', 'asdfgh', 'asdfghjkl', 'zxcv', 'zxcvbn', 'zxcvbnm',
                'qazwsx', 'edcrfv', 'tgbyhn', 'ujmik', 'olp', 'poiuytrewq', 'lkjhgfdsa', 'mnbvcxz',
                '1qaz', '2wsx', '3edc', '4rfv', '5tgb', '6yhn', '7ujm', '8ik', '9ol', '0p',
                'qazwsxedc', 'wsxedcrfv', 'edcrfvtgb', 'rfvtgbyhn', 'tgbyhnujm', 'yhnujmik', 'ujmikolp',
                'zaq1', 'xsw2', 'cde3', 'vfr4', 'bgt5', 'nhy6', 'mju7', 'mki8', 'lo9', 'p0',
                'qwe', 'wer', 'ert', 'rty', 'tyu', 'yui', 'uio', 'iop',
                'asd', 'sdf', 'dfg', 'fgh', 'ghj', 'hjk', 'jkl',
                'zxc', 'xcv', 'cvb', 'vbn', 'bnm',
                'azerty', 'ytreza', 'qsdfgh', 'hgfdsq', 'wxcvbn', 'nbvcxw', // AZERTY specific
                'qwertz', 'ztrewq', // QWERTZ specific
                
                // Misc Common
                'letmein', 'trustno1', 'changeme', 'fuckyou', 'asshole', 'bitch', 'shit', // Profanity is common
                'freedom', 'jesus', 'christ', 'god', 'heaven', 'angel', 'demon', 'hell', 'satan',
                'lucifer', 'devil', 'money', 'dollar', 'cash', 'rich', 'poor', 'success', 'boss',
                'king', 'queen', 'prince', 'princess', 'royal', 'crown', 'castle', 'palace', 'kingdom',
                'sun', 'moon', 'star', 'sky', 'cloud', 'rain', 'snow', 'wind', 'fire', 'water',
                'earth', 'world', 'universe', 'galaxy', 'planet', 'mars', 'jupiter', 'saturn', 'venus',
                'red', 'blue', 'green', 'yellow', 'orange', 'purple', 'black', 'white', 'pink', 'gold',
                'silver', 'bronze', 'metal', 'steel', 'iron', 'stone', 'rock', 'paper', 'scissor',
                'dog', 'cat', 'bird', 'fish', 'horse', 'cow', 'pig', 'sheep', 'chicken', 'duck',
                'lion', 'tiger', 'bear', 'wolf', 'fox', 'monkey', 'panda', 'koala', 'eagle', 'hawk',
                'rose', 'lily', 'tulip', 'lotus', 'jasmine', 'daisy', 'sunflower', 'violet', 'orchid',
                'apple', 'banana', 'orange', 'grape', 'melon', 'peach', 'lemon', 'lime', 'berry',
                'coffee', 'tea', 'milk', 'water', 'juice', 'soda', 'coke', 'pepsi', 'beer', 'wine',
                'pizza', 'burger', 'pasta', 'sushi', 'rice', 'bread', 'cake', 'cookie', 'candy',
                'love', 'hate', 'life', 'death', 'live', 'die', 'born', 'kill', 'peace', 'war',
                'happy', 'sad', 'angry', 'smile', 'cry', 'laugh', 'dream', 'hope', 'wish', 'believe',
                
                // Brands & Tech (More)
                'adobe', 'photoshop', 'office', 'excel', 'word', 'powerpoint', 'outlook', 'teams', 'zoom',
                'slack', 'discord', 'skype', 'whatsapp', 'telegram', 'signal', 'line', 'wechat', 'viber',
                'instagram', 'tiktok', 'snapchat', 'pinterest', 'linkedin', 'reddit', 'tumblr', 'flickr',
                'dropbox', 'icloud', 'drive', 'onedrive', 'box', 'mega', 'mediafire', 'rapidshare',
                'cisco', 'intel', 'amd', 'nvidia', 'asus', 'acer', 'dell', 'hp', 'lenovo', 'msi',
                'canon', 'nikon', 'epson', 'brother', 'panasonic', 'sharp', 'toshiba', 'hitachi', 'nec',
                'fujitsu', 'mitsubishi', 'sumitomo', 'softbank', 'au', 'docomo', 'rakuten', 'yahoo',
                
                // "Top 200" styled combinations
                'password123', 'admin123', 'secret123', 'welcome123', 'login123', 'user123', 'guest123',
                'password1234', 'admin1234', 'secret1234', 'welcome1234', 'login1234', 'user1234',
                'password!', 'admin!', 'secret!', 'welcome!', 'login!', 'user!', 'guest!',
                'password@', 'admin@', 'secret@', 'welcome@', 'login@', 'user@', 'guest@',
                'p@ssword', 'p@ssw0rd', 'P@ssword', 'P@ssw0rd', 'Pa$$word', 'admin@123', 'Password123'
            ];

            const KEYBOARD_PATTERNS = [
                'qwertyuiop', 'asdfghjkl', 'zxcvbnm', 'qazwsxedcrfvtgbyhnujmikolp', '1234567890',
                'qwe', 'wer', 'ert', 'rty', 'tyu', 'yui', 'uio', 'iop', 'asd', 'sdf', 'dfg', 'fgh', 'ghj', 'hjk', 'jkl',
                'zxc', 'xcv', 'cvb', 'vbn', 'bnm', 'poiuytrewq', 'lkjhgfdsa', 'mnbvcxz',
                'qaws', 'sxde', 'dcrf', 'fvgt', 'gbYH', 'hNju', 'jmIk', 'kiOl', 'loP',
                'qaz', 'wsx', 'edc', 'rfv', 'tgb', 'yhn', 'ujm', 'ik,', 'ol.', 'p;/', // vertical
                '1qaz', '2wsx', '3edc', '4rfv', '5tgb', '6yhn', '7ujm', '8ik,', '9ol.', '0p;/'
            ];
            const SYMBOL_PATTERNS = ['!@#$%', '^&*()', ')_+', '}{[]', '?!#@', '123!', 'abc!'];
            const REGEX_SEQUENCES_ALPHA = /(abc|bcd|cde|def|efg|fgh|ghi|hij|ijk|jkl|klm|lmn|mno|nop|opq|pqr|qrs|rst|stu|tuv|uvw|vwx|wxy|xyz)/gi;
            const REGEX_SEQUENCES_NUM = /(012|123|234|345|456|567|678|789)/g;
            const REGEX_REPEATED_3PLUS = /(.)\1\1+/g;
            const REGEX_YEAR = /\b(19\d\d|20\d\d)\b/g;

            const englishNumericUnits = [
                { power: 3,   name: 'thousand' }, { power: 6,   name: 'million' }, { power: 9,   name: 'billion' },
                { power: 12,  name: 'trillion' }, { power: 15,  name: 'quadrillion' }, { power: 18,  name: 'quintillion' },
                { power: 21,  name: 'sextillion' }, { power: 24,  name: 'septillion' }, { power: 27,  name: 'octillion' },
                { power: 30,  name: 'nonillion' }, { power: 33,  name: 'decillion' }, { power: 36,  name: 'undecillion' },
                { power: 39,  name: 'duodecillion' }, { power: 42,  name: 'tredecillion' }, { power: 45,  name: 'quattuordecillion' },
                { power: 48,  name: 'quindecillion' }, { power: 51,  name: 'sexdecillion' }, { power: 54,  name: 'septendecillion' },
                { power: 57,  name: 'octodecillion' }, { power: 60,  name: 'novemdecillion' }, { power: 63,  name: 'vigintillion' },
                { power: 66,  name: 'unvigintillion' }, { power: 69,  name: 'duovigintillion' }, { power: 72,  name: 'tresvigintillion' },
                { power: 75,  name: 'quattuorvigintillion' }, { power: 78,  name: 'quinquavigintillion' }, { power: 81,  name: 'sesvigintillion' },
                { power: 84,  name: 'septemvigintillion' }, { power: 87,  name: 'octovigintillion' }, { power: 90,  name: 'novemvigintillion' },
                { power: 93,  name: 'trigintillion' }, { power: 96,  name: 'untrigintillion' }, { power: 99,  name: 'duotrigintillion' },
                { power: 100, name: 'googol' }, { power: 102, name: 'trestrigintillion' }, { power: 105, name: 'quattuortrigintillion' },
                { power: 108, name: 'quinquatrigintillion' }, { power: 111, name: 'sestrigintillion' }, { power: 114, name: 'septentrigintillion' },
                { power: 117, name: 'octotrigintillion' }, { power: 120, name: 'noventrigintillion' }, { power: 123, name: 'quadragintillion' },
                { power: 126, name: 'thousand quadragintillion' }, { power: 129, name: 'million quadragintillion' }, { power: 132, name: 'billion quadragintillion' },
                { power: 135, name: 'trillion quadragintillion' }, { power: 138, name: 'quadrillion quadragintillion' }, { power: 141, name: 'quintillion quadragintillion' },
                { power: 144, name: 'sextillion quadragintillion' }, { power: 147, name: 'septillion quadragintillion' }, { power: 150, name: 'octillion quadragintillion' },
                { power: 153, name: 'quinquagintillion' }, { power: 156, name: 'thousand quinquagintillion' }, { power: 159, name: 'million quinquagintillion' },
                { power: 162, name: 'billion quinquagintillion' }, { power: 165, name: 'trillion quinquagintillion' }, { power: 168, name: 'quadrillion quinquagintillion' },
                { power: 171, name: 'quintillion quinquagintillion' }, { power: 174, name: 'sextillion quinquagintillion' }, { power: 177, name: 'septillion quinquagintillion' },
                { power: 180, name: 'octillion quinquagintillion' }, { power: 183, name: 'sexagintillion' }, { power: 186, name: 'thousand sexagintillion' },
                { power: 189, name: 'million sexagintillion' }, { power: 192, name: 'billion sexagintillion' }, { power: 195, name: 'trillion sexagintillion' },
                { power: 198, name: 'quadrillion sexagintillion' }, { power: 201, name: 'quintillion sexagintillion' }, { power: 204, name: 'sextillion sexagintillion' },
                { power: 207, name: 'septillion sexagintillion' }, { power: 210, name: 'octillion sexagintillion' }, { power: 213, name: 'septuagintillion' },
                { power: 216, name: 'thousand septuagintillion' }, { power: 219, name: 'million septuagintillion' }, { power: 222, name: 'billion septuagintillion' },
                { power: 225, name: 'trillion septuagintillion' }, { power: 228, name: 'quadrillion septuagintillion' }, { power: 231, name: 'quintillion septuagintillion' },
                { power: 234, name: 'sextillion septuagintillion' }, { power: 237, name: 'septillion septuagintillion' }, { power: 240, name: 'octillion septuagintillion' },
                { power: 243, name: 'octogintillion' }, { power: 246, name: 'thousand octogintillion' }, { power: 249, name: 'million octogintillion' },
                { power: 252, name: 'billion octogintillion' }, { power: 255, name: 'trillion octogintillion' }, { power: 258, name: 'quadrillion octogintillion' },
                { power: 261, name: 'quintillion octogintillion' }, { power: 264, name: 'sextillion octogintillion' }, { power: 267, name: 'septillion octogintillion' },
                { power: 270, name: 'octillion octogintillion' }, { power: 273, name: 'nonagintillion' }, { power: 276, name: 'thousand nonagintillion' },
                { power: 279, name: 'million nonagintillion' }, { power: 282, name: 'billion nonagintillion' }, { power: 285, name: 'trillion nonagintillion' },
                { power: 288, name: 'quadrillion nonagintillion' }, { power: 291, name: 'quintillion nonagintillion' }, { power: 294, name: 'sextillion nonagintillion' },
                { power: 297, name: 'septillion nonagintillion' }, { power: 300, name: 'octillion nonagintillion' }, { power: 303, name: 'centillion' },
                { power: 306, name: 'uncentillion' }
            ];

            // --- 2. Helper Functions ---

            function formatBigNum(numYears) { 
                if (numYears < 1000n) return numYears.toString();
                let found = null;
                const sortedUnits = [...englishNumericUnits].sort((a, b) => b.power - a.power);
                for (let i = 0; i < sortedUnits.length; ++i) {
                    let unit = sortedUnits[i];
                    let p = unit.power;
                    let base = 10n ** BigInt(p);
                    if (numYears >= base) { found = unit; break; }
                }
                if (!found) return numYears.toString();
                let divisor = 10n ** BigInt(found.power);
                let quotient = numYears / divisor;
                if (found.name === 'uncentillion' && numYears >= (10n ** BigInt(UNCENTILLION_POWER))) {
                     return `${quotient.toLocaleString('en')} uncentillion`;
                }
                let remainder = numYears % divisor;
                let decimal = '';
                let quotientStr = quotient.toString();
                let integerPart = parseInt(quotientStr, 10);
                let showDecimals = 0;
                if (integerPart < 10) showDecimals = 2;
                else if (integerPart < 100) showDecimals = 1;
                if (showDecimals > 0 && remainder > 0n) {
                    let scale = 10n ** BigInt(showDecimals);
                    let fraction = (remainder * scale) / divisor;
                    if (fraction > 0n) {
                        let fractionStr = fraction.toString().padStart(showDecimals, '0');
                        let significantFraction = fractionStr.replace(/0+$/, '');
                        if (significantFraction.length > 0) decimal = '.' + significantFraction;
                    }
                }
                return quotient.toLocaleString('en') + decimal + ' ' + found.name;
            }

            function secondsToEnglishUnit(seconds) {
                if (seconds >= MAX_DISPLAYABLE_UNCENTILLION_SECONDS) return 'uncentillion 年以上';
                if (seconds >= 1n) {
                    if (seconds < 60n) return (seconds > 1n ? seconds.toLocaleString('en') + ' 秒' : '1 秒');
                    if (seconds < 3600n) return (seconds / 60n).toLocaleString('en') + ' 分';
                    if (seconds < 86400n) return (seconds / 3600n).toLocaleString('en') + ' 時間';
                    if (seconds < SECONDS_PER_YEAR) return (seconds / 86400n).toLocaleString('en') + ' 日';
                    const years = seconds / SECONDS_PER_YEAR;
                    return formatBigNum(years) + ' 年';
                }
                return '瞬時';
            }

            function formatTimeLabel(val) {
                if(val < 1) return (val * 1000).toFixed(0) + " ms";
                if(val < 60) return val.toFixed(0) + " s";
                if(val < 3600) return (val/60).toFixed(0) + " m";
                if(val < 86400) return (val/3600).toFixed(0) + " h";
                if(val < 31536000) return (val/86400).toFixed(0) + " d";
                
                try {
                    const years = BigInt(Math.floor(val / 31536000));
                    return formatBigNum(years) + " yr";
                } catch(e) {
                    return val.toExponential(1);
                }
            }

            function setHighchartsTheme(isDark) {
                const textColor = isDark ? '#e0e0e0' : '#333333';
                const gridColor = isDark ? '#444444' : '#e6e6e6';
                Highcharts.setOptions({
                    chart: { backgroundColor: 'transparent' },
                    title: { style: { color: textColor } },
                    subtitle: { style: { color: textColor } },
                    legend: { itemStyle: { color: textColor } },
                    xAxis: { 
                        labels: { style: { color: textColor } },
                        lineColor: gridColor,
                        tickColor: gridColor,
                        title: { style: { color: textColor } }
                    },
                    yAxis: { 
                        labels: { style: { color: textColor } },
                        gridLineColor: gridColor,
                        title: { style: { color: textColor } }
                    },
                    plotOptions: {
                        series: { borderColor: isDark ? '#212529' : '#ffffff' },
                        pie: { 
                            dataLabels: { 
                                style: { 
                                    color: textColor, 
                                    textOutline: isDark ? 'none' : '1px contrast' 
                                } 
                            } 
                        }
                    },
                    tooltip: {
                        backgroundColor: isDark ? 'rgba(33, 37, 41, 0.95)' : 'rgba(255, 255, 255, 0.95)',
                        style: { color: isDark ? '#f8f9fa' : '#333333' }
                    }
                });
                
                if(compositionChart) compositionChart.update({});
                if(deviceTimeChart) deviceTimeChart.update({});
                if(hashrateChart) hashrateChart.update({});
                if(transitionChart) transitionChart.update({});
            }

            function calculateCharacterPoolSize(password) {
                let pool = 0;
                let charTypes = 0;
                let counts = { lower: 0, upper: 0, number: 0, symbol: 0 };
                const lowerMatch = password.match(/[a-z]/g);
                if (lowerMatch) { pool += 26; charTypes++; counts.lower = lowerMatch.length; }
                const upperMatch = password.match(/[A-Z]/g);
                if (upperMatch) { pool += 26; charTypes++; counts.upper = upperMatch.length; }
                const numberMatch = password.match(/[0-9]/g);
                if (numberMatch) { pool += 10; charTypes++; counts.number = numberMatch.length; }
                const symbols = password.replace(/[a-zA-Z0-9]/g, '');
                if (symbols.length > 0) {
                    const uniqueSymbols = new Set(symbols.split('')).size;
                    pool += Math.min(33, uniqueSymbols * 2);
                    charTypes++;
                    counts.symbol = symbols.length;
                }
                return { pool: Math.max(pool, 1), charTypes: charTypes, counts: counts };
            }

            function calculateBaseEntropy(password) {
                if (!password) return 0;
                const { pool } = calculateCharacterPoolSize(password);
                return password.length * (Math.log(pool) / Math.log(2));
            }

            function getDictionaryPenalty(password) {
                let penalty = 0;
                let foundPatterns = [];
                const lowerPassword = password.toLowerCase();
                for (const common of COMMON_PASSWORDS) {
                    if (lowerPassword.includes(common.toLowerCase())) {
                        penalty += Math.min(25, common.length * 1.5 + (password.length === common.length ? 5: 0) );
                        if (!foundPatterns.includes(`一般的な単語: "${common}"`)) foundPatterns.push(`一般的な単語: "${common}"`);
                    }
                }
                let leetPassword = lowerPassword.replace(/0/g, 'o').replace(/3/g, 'e').replace(/@/g, 'a')
                    .replace(/1/g, 'i').replace(/!/g, 'i').replace(/5/g, 's').replace(/\$/g, 's').replace(/7/g, 't');
                if (leetPassword !== lowerPassword) {
                     for (const common of COMMON_PASSWORDS) {
                        if (leetPassword.includes(common.toLowerCase())) {
                            penalty += Math.min(20, common.length * 1.2);
                            if (!foundPatterns.includes(`Leet変換単語: "${common}"`)) foundPatterns.push(`Leet変換単語: "${common}"`);
                        }
                    }
                }
                return { penalty, foundPatterns };
            }
            
            function getPatternPenalty(password) {
                let penalty = 0;
                let foundPatterns = [];
                const lowerPassword = password.toLowerCase();
                let match;
                const checkSequence = (regex, basePenalty, targetString, labelPrefix) => {
                    let tempPass = targetString;
                    regex.lastIndex = 0; 
                    while ((match = regex.exec(tempPass)) !== null) {
                        penalty += Math.min(basePenalty, match[0].length * 1.5);
                        foundPatterns.push(`${labelPrefix}: "${match[0]}"`);
                        tempPass = tempPass.substring(match.index + 1);
                        regex.lastIndex = 0;
                    }
                };
                checkSequence(REGEX_SEQUENCES_ALPHA, 10, lowerPassword, "アルファベット順");
                checkSequence(REGEX_SEQUENCES_NUM, 8, lowerPassword, "数字順");
                let tempPassRepeat3 = password;
                REGEX_REPEATED_3PLUS.lastIndex = 0;
                while ((match = REGEX_REPEATED_3PLUS.exec(tempPassRepeat3)) !== null) {
                    penalty += Math.min(10, match[0].length * 2);
                    foundPatterns.push(`連続する文字(3+): "${match[0]}"`);
                    tempPassRepeat3 = tempPassRepeat3.substring(match.index + 1);
                    REGEX_REPEATED_3PLUS.lastIndex = 0;
                }
                for (const pattern of KEYBOARD_PATTERNS.concat(SYMBOL_PATTERNS)) {
                    if (lowerPassword.includes(pattern)) {
                        penalty += Math.min(12, pattern.length * 1.2 + (lowerPassword.length === pattern.length ? 3:0));
                        foundPatterns.push(`キーボード配列: "${pattern}"`);
                    }
                }
                REGEX_YEAR.lastIndex = 0;
                if (REGEX_YEAR.test(password)) {
                    penalty += 5;
                    foundPatterns.push("年号パターン");
                }
                return { penalty, foundPatterns };
            }

            function calculateEffectiveEntropy(password) {
                if (!password) return { entropy: 0, patterns: [] };
                const baseEntropy = calculateBaseEntropy(password);
                let totalPenalty = 0;
                let allPatterns = [];
                if (password.length < 8) { totalPenalty += 20; allPatterns.push("短すぎる (8文字未満)"); }
                else if (password.length < 10) totalPenalty += 10;
                else if (password.length < 12) totalPenalty += 5;
                const { charTypes } = calculateCharacterPoolSize(password);
                if (charTypes === 1 && password.length > 1) { totalPenalty += 10; allPatterns.push("文字種が1種類のみ"); }
                else if (charTypes === 2 && password.length > 3) { totalPenalty += 5; }
                const dictResult = getDictionaryPenalty(password);
                totalPenalty += dictResult.penalty;
                allPatterns = allPatterns.concat(dictResult.foundPatterns);
                const patternResult = getPatternPenalty(password);
                totalPenalty += patternResult.penalty;
                allPatterns = allPatterns.concat(patternResult.foundPatterns);
                if (/^[a-z]+$/.test(password) && password.length > 4) totalPenalty += 3;
                if (/^[A-Z]+$/.test(password) && password.length > 4) totalPenalty += 3;
                if (/^[0-9]+$/.test(password) && password.length > 4) totalPenalty += 3;
                let effectiveEntropy = Math.max(0, baseEntropy - totalPenalty);
                if (password.length <= 3) {
                    effectiveEntropy = Math.min(effectiveEntropy, password.length * 4);
                } else if (password.length <= 5) {
                    effectiveEntropy = Math.min(effectiveEntropy, password.length * 5);
                }
                return { entropy: effectiveEntropy, patterns: [...new Set(allPatterns)] };
            }

            function calculateCrackTimeSeconds(entropy, speed) {
                if (entropy <= 0.1) return 0n;
                const CLIPPING_SECONDS_VALUE = (999n * (10n ** 306n) * SECONDS_PER_YEAR) + 1n; 
                if (entropy > 1090) return CLIPPING_SECONDS_VALUE;
                let combinations;
                try {
                    const intEntropy = BigInt(Math.max(1, Math.round(entropy)));
                    combinations = 2n ** intEntropy;
                } catch (e) { return CLIPPING_SECONDS_VALUE; }
                if (combinations === 0n && entropy > 0) return 0n;
                const crackTime = combinations / speed;
                if (crackTime >= CLIPPING_SECONDS_VALUE) return CLIPPING_SECONDS_VALUE;
                return crackTime < 0n ? 0n : crackTime;
            }
            
            function getStrengthLevelFromEntropy(entropy) {
                if (entropy < 28) return { text: '危険', step: 1, percent: 10 };
                if (entropy < 36) return { text: '非常に弱い', step: 2, percent: 20 };
                if (entropy < 60) return { text: '弱い', step: 3, percent: 30 };
                if (entropy < 70) return { text: 'やや弱い', step: 4, percent: 40 };
                if (entropy < 80) return { text: '普通', step: 5, percent: 50 };
                if (entropy < 90) return { text: 'やや強い', step: 6, percent: 60 };
                if (entropy < 100) return { text: '強い', step: 7, percent: 70 };
                if (entropy < 110) return { text: '非常に強い', step: 8, percent: 80 };
                if (entropy < 128) return { text: '極めて強い', step: 9, percent: 90 };
                return { text: 'ほぼ解読不能', step: 10, percent: 100 };
            }

            // --- 3. UI Update Functions ---

            function updatePatternList(patterns) {
                const list = document.getElementById('patternList');
                list.innerHTML = '';
                if (patterns.length === 0) {
                    list.innerHTML = '<span class="text-muted fst-italic small">パターンは検出されていません</span>';
                    return;
                }
                patterns.forEach(p => {
                    const span = document.createElement('span');
                    span.className = 'detected-pattern bg-warning-subtle text-warning-emphasis border border-warning-subtle rounded px-2 py-1 me-1 mb-1 d-inline-block small';
                    span.textContent = p;
                    list.appendChild(span);
                });
            }

            function updateDeviceTimeList(effectiveEntropy) {
                deviceTimeListElement.innerHTML = '';
                DEVICES.forEach(device => {
                    const sec = calculateCrackTimeSeconds(effectiveEntropy, device.speed);
                    const timeStr = secondsToEnglishUnit(sec);
                    
                    const div = document.createElement('div');
                    div.className = 'device-card';
                    div.innerHTML = `
                        <div class="device-header">
                            <span class="device-name"><i class="bi bi-cpu me-1"></i>${device.name}</span>
                            <span class="device-time">${timeStr}</span>
                        </div>
                        <div class="device-desc">${device.desc}</div>
                    `;
                    deviceTimeListElement.appendChild(div);
                });
            }

            function updateCompositionChart(counts) {
                const data = [
                    { name: '大文字', y: counts.upper, color: '#0d6efd' },
                    { name: '小文字', y: counts.lower, color: '#6610f2' },
                    { name: '数字', y: counts.number, color: '#198754' },
                    { name: '記号', y: counts.symbol, color: '#fd7e14' }
                ].filter(d => d.y > 0);

                if (!compositionChart) {
                    compositionChart = Highcharts.chart('compositionChart', {
                        chart: { type: 'pie', backgroundColor: 'transparent' },
                        title: { text: null },
                        credits: { enabled: false },
                        tooltip: { pointFormat: '<b>{point.y} 文字</b>' },
                        plotOptions: {
                            pie: {
                                innerSize: '60%',
                                dataLabels: {
                                    enabled: true,
                                    format: '<b>{point.name}</b>: {point.percentage:.1f} %',
                                    distance: 10,
                                    style: { fontSize: '0.8rem' }
                                }
                            }
                        },
                        series: [{ name: '文字数', data: data }]
                    });
                } else {
                    compositionChart.series[0].setData(data);
                }
            }

            function updateDeviceTimeChart(entropy) {
                const combinations = 2 ** entropy;
                const seriesData = DEVICES.map(d => {
                    let val = combinations / Number(d.speed);
                    if(val < 1e-6) val = 1e-6; // Avoid log error
                    return { y: val, color: d.color };
                });

                if (!deviceTimeChart) {
                    deviceTimeChart = Highcharts.chart('deviceTimeChart', {
                        chart: { type: 'bar', backgroundColor: 'transparent' },
                        title: { text: 'デバイス別推定解析時間', style: { fontSize: '14px' } },
                        credits: { enabled: false },
                        xAxis: { 
                            categories: DEVICES.map(d => d.name),
                            title: { text: null },
                            labels: {
                                style: { textOverflow: 'none' } 
                            }
                        },
                        yAxis: { 
                            type: 'logarithmic', 
                            title: { text: 'Time' },
                            labels: {
                                formatter: function() { return formatTimeLabel(this.value); }
                            }
                        },
                        tooltip: {
                            formatter: function() {
                                return `<b>${this.point.category}</b><br/>${formatTimeLabel(this.y)}`;
                            }
                        },
                        legend: { enabled: false },
                        series: [{ name: '解析時間', data: seriesData }]
                    });
                } else {
                    deviceTimeChart.series[0].setData(seriesData);
                }
            }

            function updateHashrateChart() {
                const data = DEVICES.map(d => {
                    let customLabel = '';
                    if (d.speed >= 1_000_000_000_000_000_000n) customLabel = (d.speed/1_000_000_000_000_000_000n).toString() + ' EH/s';
                    else if (d.speed >= 1_000_000_000_000_000n) customLabel = (d.speed/1_000_000_000_000_000n).toString() + ' PH/s';
                    else if (d.speed >= 1_000_000_000_000n) customLabel = (d.speed/1_000_000_000_000n).toString() + ' TH/s';
                    else if (d.speed >= 1_000_000_000n) customLabel = (d.speed/1_000_000_000n).toString() + ' GH/s';
                    else if (d.speed >= 1_000_000n) customLabel = (d.speed/1_000_000n).toString() + ' MH/s';
                    else customLabel = '0';

                    return { 
                        y: Number(d.speed), 
                        color: d.color,
                        customLabel: customLabel
                    };
                });
                
                if (!hashrateChart) {
                    hashrateChart = Highcharts.chart('hashrateChart', {
                        chart: { type: 'column', backgroundColor: 'transparent' },
                        title: { text: 'デバイス別 Hash/s 性能比較', style: { fontSize: '14px' } },
                        subtitle: { text: '2025年時点の推計値'},
                        credits: { enabled: false },
                        xAxis: { 
                            categories: DEVICES.map(d => d.name),
                            crosshair: true
                        },
                        yAxis: { 
                            type: 'logarithmic', 
                            title: { text: 'Hashes per Second' }
                        },
                        tooltip: { 
                             formatter: function() {
                                return `<b>${this.point.category}</b><br/>${this.point.customLabel}<br/>(${this.y.toExponential(2)} H/s)`;
                            }
                        },
                        legend: { enabled: false },
                        series: [{ name: 'Hash Rate', data: data }]
                    });
                }
            }

            function updateTransitionChart(newEntropy) {
                entropyHistory.push(newEntropy);
                const seriesData = entropyHistory.map((val, idx) => ({ x: idx, y: val }));

                if (!transitionChart) {
                    transitionChart = Highcharts.chart('transitionChart', {
                        chart: { type: 'spline', backgroundColor: 'transparent' },
                        title: { text: 'エントロピーの推移', style: { fontSize: '14px' } },
                        credits: { enabled: false },
                        xAxis: { 
                            title: { text: '入力ステップ' }, 
                            allowDecimals: false
                        },
                        yAxis: { 
                            title: { text: 'Entropy (bits)' },
                            min: 0,
                            plotLines: [{ value: 60, color: 'orange', dashStyle: 'shortdash', width: 2, label: { text: '弱い' } }, { value: 100, color: 'green', dashStyle: 'shortdash', width: 2, label: { text: '強い' } }]
                        },
                        series: [{ 
                            name: 'Entropy', 
                            data: seriesData,
                            color: '#20c997',
                            marker: { enabled: false }
                        }]
                    });
                } else {
                    transitionChart.series[0].setData(seriesData);
                }
            }

            function evaluatePassword() {
                const password = passwordInput.value;
                const length = password.length;
                let newCrackTimeText = '-';
                let newPasswordStrengthText = '-';
                let newEntropyValueText = '-'; 
                let strengthColorClass = '';
                let progressPercent = 0;

                const setBadge = (element, isMet) => {
                    if (isMet) {
                        element.classList.add('met');
                        element.querySelector('i').className = 'bi bi-check-circle-fill';
                    } else {
                        element.classList.remove('met');
                        element.querySelector('i').className = 'bi bi-x-circle';
                    }
                };

                if (length === 0) {
                    strengthBarIndicator.style.width = '0%';
                    strengthBarIndicator.className = 'strength-bar-indicator';
                    strengthProgress.style.width = '0%';
                    [lengthCheck, uppercaseCheck, lowercaseCheck, numberCheck, symbolCheck].forEach(el => setBadge(el, false));
                    updatePatternList([]);
                    updateDeviceTimeList(0);
                    if(compositionChart) compositionChart.series[0].setData([]);
                    if(deviceTimeChart) deviceTimeChart.series[0].setData([]);
                    updateTransitionChart(0);
                } else {
                    const counts = calculateCharacterPoolSize(password).counts;
                    const hasUppercase = /[A-Z]/.test(password);
                    const hasLowercase = /[a-z]/.test(password);
                    const hasNumber = /[0-9]/.test(password);
                    const hasSymbol = /[^A-Za-z0-9]/.test(password);

                    const result = calculateEffectiveEntropy(password);
                    const effectiveEntropy = result.entropy;
                    
                    const totalSeconds = calculateCrackTimeSeconds(effectiveEntropy, ATTEMPTS_PER_SECOND_MAIN);
                    newCrackTimeText = secondsToEnglishUnit(totalSeconds);
                    
                    const strengthInfo = getStrengthLevelFromEntropy(effectiveEntropy);
                    newPasswordStrengthText = strengthInfo.text;
                    strengthColorClass = 'text-step' + strengthInfo.step;
                    progressPercent = strengthInfo.percent;

                    newEntropyValueText = effectiveEntropy > 0 ? effectiveEntropy.toFixed(1) + ' bits' : (length > 0 ? '0.0 bits' : '-');

                    strengthBarIndicator.style.width = progressPercent + '%';
                    strengthBarIndicator.className = 'strength-bar-indicator color-step' + strengthInfo.step;
                    
                    strengthProgress.style.width = progressPercent + '%';
                    strengthProgress.className = 'progress-bar color-step' + strengthInfo.step;

                    setBadge(lengthCheck, length >= 8);
                    setBadge(uppercaseCheck, hasUppercase);
                    setBadge(lowercaseCheck, hasLowercase);
                    setBadge(numberCheck, hasNumber);
                    setBadge(symbolCheck, hasSymbol);

                    updatePatternList(result.patterns);
                    updateDeviceTimeList(effectiveEntropy);
                    updateCompositionChart(counts);
                    updateDeviceTimeChart(effectiveEntropy);
                    updateTransitionChart(effectiveEntropy);
                }

                crackTimeElement.textContent = newCrackTimeText;
                passwordStrengthElement.textContent = newPasswordStrengthText;
                passwordStrengthElement.className = 'result-value ' + strengthColorClass;
                entropyValueElement.textContent = newEntropyValueText;
                entropyValueElement.className = 'result-value ' + strengthColorClass;
            }

            // Table Generation Functions
            function calcCrackTimeSecondsForTable(charsetSize, length) {
                const ATTEMPTS_PER_SECOND_TABLE = 1_000_000_000n; // 10^9
                const TABLE_CLIPPING_SECONDS_VALUE = MAX_DISPLAYABLE_UNCENTILLION_SECONDS + 1n; 

                if (length < 1) return 0n;
                const baseEntropy = length * (Math.log(Number(charsetSize)) / Math.log(2));
                if (baseEntropy > 1070) return TABLE_CLIPPING_SECONDS_VALUE;
                try {
                    let combinations = charsetSize ** BigInt(length);
                    let crackTime = combinations / ATTEMPTS_PER_SECOND_TABLE;
                    if (crackTime >= TABLE_CLIPPING_SECONDS_VALUE) return TABLE_CLIPPING_SECONDS_VALUE;
                    return crackTime;
                } catch (e) { return TABLE_CLIPPING_SECONDS_VALUE; }
            }

            function getColorClassForTimeForTable(seconds) {
                if (seconds >= MAX_DISPLAYABLE_UNCENTILLION_SECONDS) return 'color-step10';
                if (seconds >= 1n) {
                    const MINUTE = 60n; const HOUR = 60n * MINUTE; const DAY = 24n * HOUR; const YEAR = SECONDS_PER_YEAR;
                    if (seconds < MINUTE) return 'color-step2';
                    if (seconds < HOUR * 3n) return 'color-step3';
                    if (seconds < DAY * 2n) return 'color-step4';
                    if (seconds < DAY * 60n) return 'color-step5';
                    if (seconds < YEAR * 50n) return 'color-step6';
                    if (seconds < YEAR * 3000n) return 'color-step7';
                    if (seconds < YEAR * 2000000n) return 'color-step8';
                    if (seconds < YEAR * (10n ** 12n)) return 'color-step9';
                    return 'color-step10';
                }
                return 'color-step1';
            }

            function generateCrackTimeTable() {
                const tbody = document.querySelector('#passwordStrengthTable tbody');
                const categories = ['num', 'lower', 'upperLower', 'numUpperLower', 'all'];
                const charsetSizesForTable = { num: 10n, lower: 26n, upperLower: 52n, numUpperLower: 62n, all: 95n };
                const fragment = document.createDocumentFragment();
                
                for (let len = 4; len <= 323; ++len) { 
                    const row = document.createElement('tr');
                    
                    const cellLen = document.createElement('td');
                    cellLen.textContent = len;
                    row.appendChild(cellLen);

                    categories.forEach(catKey => {
                        const cell = document.createElement('td');
                        const charsetSize = charsetSizesForTable[catKey];
                        let sec = calcCrackTimeSecondsForTable(charsetSize, len);
                        cell.textContent = secondsToEnglishUnit(sec);
                        const colorClass = getColorClassForTimeForTable(sec);
                        if (colorClass) cell.className = colorClass;
                        row.appendChild(cell);
                    });
                    fragment.appendChild(row);
                }
                tbody.appendChild(fragment);
            }

            function generateNumericUnitsTable() {
                const tbody = document.querySelector('#numericUnitsTable tbody');
                const sortedUnits = [...englishNumericUnits].sort((a,b) => a.power - b.power);
                sortedUnits.forEach(unit => {
                    const row = tbody.insertRow();
                    row.insertCell().textContent = unit.name;
                    row.insertCell().textContent = '10^' + unit.power;
                });
            }

            function generateStrengthLevelsTable() {
                const tbody = document.querySelector('#strengthLevelsTable tbody');
                const strengthSteps = [
                    { level: '危険 (エントロピー <28 bit)', color: 'color-step1' },
                    { level: '非常に弱い (28-35 bit)', color: 'color-step2' },
                    { level: '弱い (36-59 bit)', color: 'color-step3' },
                    { level: 'やや弱い (60-69 bit)', color: 'color-step4' },
                    { level: '普通 (70-79 bit)', color: 'color-step5' },
                    { level: 'やや強い (80-89 bit)', color: 'color-step6' },
                    { level: '強い (90-99 bit)', color: 'color-step7' },
                    { level: '非常に強い (100-109 bit)', color: 'color-step8' },
                    { level: '極めて強い (110-127 bit)', color: 'color-step9' },
                    { level: 'ほぼ解読不能 (≧128 bit)', color: 'color-step10' }
                ];
                strengthSteps.forEach(step => {
                    const row = tbody.insertRow();
                    row.insertCell().textContent = step.level;
                    const colorCell = row.insertCell();
                    const badge = document.createElement('span');
                    badge.className = `badge rounded-pill ${step.color}`;
                    badge.style.width = '60px';
                    badge.innerHTML = '&nbsp;';
                    colorCell.appendChild(badge);
                });
            }
            
            // New: Generate Internal Logic Disclosure
            function renderLogicDetails() {
                const container = document.getElementById('logicDetailsContent');
                
                const html = `
                    <h6 class="fw-bold mt-3">1. 基本エントロピー計算</h6>
                    <div class="logic-code-block">BaseEntropy = Length * log2(CharacterPoolSize)</div>
                    
                    <h6 class="fw-bold mt-3">2. 減点（ペナルティ）ルール一覧</h6>
                    <ul class="list-unstyled small">
                        <li class="logic-list-item"><strong>文字数不足:</strong> 8文字未満=-20bit, 10文字未満=-10bit, 12文字未満=-5bit</li>
                        <li class="logic-list-item"><strong>文字種の偏り:</strong> 1種類のみ=-10bit, 2種類かつ短文=-5bit</li>
                        <li class="logic-list-item"><strong>辞書攻撃 (完全一致/部分一致):</strong> <code>Math.min(25, Length * 1.5 + Bonus)</code> の減点</li>
                        <li class="logic-list-item"><strong>Leet変換 (a→@など):</strong> <code>Math.min(20, Length * 1.2)</code> の減点</li>
                        <li class="logic-list-item"><strong>連番 (abc, 123):</strong> 英字=-10bitベース, 数字=-8bitベース</li>
                        <li class="logic-list-item"><strong>繰り返し (aaa):</strong> -10bitベース</li>
                        <li class="logic-list-item"><strong>キーボード配列 (qwerty):</strong> <code>Math.min(12, Length * 1.2)</code> の減点</li>
                        <li class="logic-list-item"><strong>年号 (19xx, 20xx):</strong> -5bit</li>
                        <li class="logic-list-item"><strong>単純な構造 (数字のみ/英字のみで4文字以上):</strong> -3bit (Entropy減少として処理)</li>
                    </ul>

                    <h6 class="fw-bold mt-3">3. 内部辞書データ (Common Passwords List)</h6>
                    <div class="logic-code-block">${JSON.stringify(COMMON_PASSWORDS, null, 2)}</div>
                    
                    <h6 class="fw-bold mt-3">4. キーボードパターン (Keyboard Patterns)</h6>
                    <div class="logic-code-block">${JSON.stringify(KEYBOARD_PATTERNS, null, 2)}</div>
                    
                    <h6 class="fw-bold mt-3">5. 記号パターン (Symbol Patterns)</h6>
                    <div class="logic-code-block">${JSON.stringify(SYMBOL_PATTERNS, null, 2)}</div>
                `;
                
                container.innerHTML = html;
            }

            // --- 4. Initialization ---

            // Theme Detection & Setting
            const getPreferredTheme = () => window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            
            const setTheme = (theme) => {
                htmlElement.setAttribute('data-bs-theme', theme);
                themeIcon.className = theme === 'light' ? 'bi bi-circle-half' : 'bi bi-moon-stars-fill';
                setHighchartsTheme(theme === 'dark');
            };

            setTheme(getPreferredTheme());

            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                setTheme(event.matches ? 'dark' : 'light');
            });

            themeToggle.addEventListener('click', () => {
                const currentTheme = htmlElement.getAttribute('data-bs-theme');
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                setTheme(newTheme);
            });

            const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]');
            [...popoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl, { html: true }));

            togglePassword.addEventListener('click', () => {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                togglePassword.innerHTML = (type === 'password') ? '<i class="bi bi-eye-fill"></i>' : '<i class="bi bi-eye-slash-fill"></i>';
            });

            resetTransitionChartBtn.addEventListener('click', () => {
                entropyHistory = [];
                if(transitionChart) transitionChart.series[0].setData([]);
            });

            passwordInput.addEventListener('input', evaluatePassword);

            // Execute
            generateCrackTimeTable();
            generateNumericUnitsTable();
            generateStrengthLevelsTable();
            renderLogicDetails(); // New Function Call
            updateHashrateChart();
            evaluatePassword();
        });
    </script>
</body>
</html>
